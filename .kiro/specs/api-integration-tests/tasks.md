# Implementation Plan: API 集成测试

## Overview

按照用户使用场景的顺序实现 API 集成测试，从测试基础设施开始，逐步覆盖所有 API 端点。

## Tasks

- [x] 1. 创建测试基础设施
  - [x] 1.1 创建 API 测试客户端 (test-api-client.ts)
    - 封装 $fetch 发送 HTTP 请求
    - 支持 GET、POST、PUT、DELETE 方法
    - 支持设置 Authorization 头
    - 返回完整响应信息
    - _Requirements: 1.1, 1.2, 1.3, 1.4_
  - [x] 1.2 创建测试辅助函数 (test-api-helpers.ts)
    - 创建测试用户（带密码）
    - 创建短信验证码记录
    - 注册并登录辅助函数
    - 数据清理函数
    - _Requirements: 1.5, 1.6_
  - [x] 1.3 创建测试目录 README.md
    - 模块说明
    - 测试文件列表
    - 运行命令
    - _Requirements: 1.1_

- [x] 2. 健康检查测试 (01-health.test.ts)
  - [x] 2.1 实现健康检查端点测试
    - 测试 GET /api/health 返回服务状态
    - _Requirements: 13.1_

- [x] 3. 认证流程测试 (02-auth.test.ts)
  - [x] 3.1 实现注册测试
    - 测试有效注册信息创建用户
    - 测试已存在手机号注册失败
    - 测试通过邀请链接注册记录推荐人
    - _Requirements: 2.1, 2.2, 2.3_
  - [x] 3.2 实现密码登录测试
    - 测试正确密码登录成功
    - 测试错误密码登录失败
    - _Requirements: 2.4, 2.5_
  - [x] 3.3 实现短信登录测试
    - 测试有效验证码登录成功
    - 测试无效验证码登录失败
    - _Requirements: 2.6, 2.7_
  - [x] 3.4 实现登出测试
    - 测试登出使 token 失效
    - _Requirements: 2.8_
  - [x] 3.5 实现重置密码测试
    - 测试重置密码成功
    - 测试重置后新密码可登录
    - _Requirements: 2.9, 2.10_
  - [x] 3.6 实现认证属性测试
    - **Property 1: 认证令牌有效性**
    - **Property 3: 密码重置后登录一致性**
    - **Validates: Requirements 2.4, 2.6, 2.9, 2.10, 4.1**

- [x] 4. 短信验证码测试 (03-sms.test.ts)
  - [x] 4.1 实现发送验证码测试
    - 测试发送验证码到有效手机号
    - 测试频率限制
    - 测试无效手机号格式
    - _Requirements: 3.1, 3.2, 3.3_

- [-] 5. 用户信息测试 (04-users.test.ts)
  - [x] 5.1 实现获取用户信息测试
    - 测试已认证用户获取个人信息
    - 测试未认证用户返回 401
    - _Requirements: 4.1, 4.2_
  - [x] 5.2 实现更新用户信息测试
    - 测试更新个人资料
    - 测试修改密码（正确旧密码）
    - 测试修改密码（错误旧密码）
    - _Requirements: 4.3, 4.4, 4.5_
  - [x] 5.3 实现角色和权限测试
    - 测试获取角色信息
    - 测试获取路由权限
    - _Requirements: 4.6, 4.7_
  - [x] 5.4 实现邀请列表测试
    - 测试获取邀请列表
    - _Requirements: 4.8_
  - [x] 5.5 实现未认证请求属性测试
    - **Property 2: 未认证请求拒绝**
    - **Validates: Requirements 4.2**

- [x] 6. 会员系统测试 (05-memberships.test.ts)
  - [x] 6.1 实现会员等级测试
    - 测试获取会员等级列表
    - 测试获取特定等级详情
    - _Requirements: 5.1, 5.2_
  - [x] 6.2 实现用户会员信息测试
    - 测试获取当前会员信息
    - 测试获取会员权益
    - 测试获取会员历史
    - _Requirements: 5.3, 5.4, 5.5_
  - [x] 6.3 实现会员升级测试
    - 测试获取升级选项
    - 测试计算升级费用
    - 测试获取升级记录
    - _Requirements: 5.6, 5.7, 5.8_

- [x] 7. 积分系统测试 (06-points.test.ts)
  - [x] 7.1 实现积分信息测试
    - 测试获取积分信息
    - 测试获取积分记录
    - 测试获取积分使用情况
    - _Requirements: 6.1, 6.2, 6.3_

- [x] 8. 兑换码测试 (07-redemption.test.ts)
  - [x] 8.1 实现兑换码查询测试
    - 测试查询有效兑换码
    - 测试查询无效兑换码
    - _Requirements: 7.1, 7.2_
  - [x] 8.2 实现兑换码使用测试
    - 测试使用有效兑换码
    - 测试使用已使用的兑换码
    - _Requirements: 7.3, 7.4_
  - [x] 8.3 实现兑换历史测试
    - 测试获取已兑换列表
    - _Requirements: 7.5_

- [x] 9. 营销活动测试 (08-campaigns.test.ts)
  - [x] 9.1 实现活动列表测试
    - 测试获取活动列表
    - 测试获取特定活动详情
    - 测试获取不存在的活动
    - _Requirements: 8.1, 8.2, 8.3_
  - [x] 9.2 实现邀请奖励测试
    - 测试邀请注册触发奖励
    - 测试推荐人和被邀请人奖励发放
    - _Requirements: 8.4, 8.5_
  - [x] 9.3 实现邀请奖励属性测试
    - **Property 4: 邀请注册奖励一致性**
    - **Validates: Requirements 2.3, 8.4, 8.5**

- [x] 10. 产品信息测试 (09-products.test.ts)
  - [x] 10.1 实现产品列表测试
    - 测试获取产品列表
    - 测试获取特定产品详情
    - 测试获取不存在的产品
    - _Requirements: 9.1, 9.2, 9.3_

- [x] 11. 支付系统测试 (10-payments.test.ts)
  - [x] 11.1 实现支付订单测试
    - 测试创建支付订单
    - 测试查询订单状态
    - _Requirements: 10.1, 10.2_
  - [x] 11.2 实现支付回调测试
    - 测试支付回调更新订单状态
    - _Requirements: 10.3_

- [x] 12. 文件存储测试 (11-storage.test.ts)
  - [x] 12.1 实现存储配置测试
    - 测试获取上传配置
    - 测试获取预签名上传 URL
    - _Requirements: 11.1, 11.2_
  - [x] 12.2 实现文件操作测试
    - 测试获取文件列表
    - 测试获取下载 URL
    - 测试删除文件
    - _Requirements: 11.3, 11.4, 11.5_
  - [x] 12.3 实现 OSS 回调测试
    - 测试 OSS 回调处理
    - _Requirements: 11.6_

- [x] 13. 加密配置测试 (12-encryption.test.ts)
  - [x] 13.1 实现加密配置测试
    - 测试获取加密配置
    - 测试创建加密配置
    - 测试更新加密配置
    - _Requirements: 12.1, 12.2, 12.3_
  - [x] 13.2 实现恢复密钥测试
    - 测试获取恢复密钥
    - 测试使用恢复密钥恢复
    - _Requirements: 12.4, 12.5_

- [x] 14. 更新 package.json 和文档
  - [x] 14.1 添加测试脚本
    - 添加 test:api 脚本
    - _Requirements: 1.1_
  - [x] 14.2 更新 tests/server/README.md
    - 添加 API 测试模块说明
    - _Requirements: 1.1_

- [x] 15. Checkpoint - 确保所有测试通过
  - 运行所有 API 测试
  - 确保测试覆盖所有需求
  - 如有问题请询问用户

## Notes

- 所有任务都是必须完成的，包括属性测试
- 每个任务都引用了具体的需求编号，确保可追溯性
- 测试按用户使用场景顺序组织，便于理解和维护
- 属性测试用于验证系统的通用正确性属性
