# 实现计划: 会员升级价格计算修复

## 概述

本实现计划将会员升级价格计算的修复工作分解为可执行的任务，主要修改 `calculateUpgradePrice` 函数的计算逻辑。

## 任务列表

- [x] 1. 修改升级价格计算函数
  - [x] 1.1 修改 calculateUpgradePrice 函数
    - 修改 `server/services/membership/membershipUpgrade.service.ts` 中的 `calculateUpgradePrice` 函数
    - 将计算逻辑从"套餐比例"改为"实际剩余天数"
    - 日均价值 = 实付金额 / 总天数
    - 当前剩余价值 = 日均价值 × 剩余天数
    - 目标日均价值 = 目标年价 / 365
    - 目标剩余价值 = 目标日均价值 × 剩余天数
    - 升级价格 = max(0, 目标剩余价值 - 当前剩余价值)
    - _Requirements: 1.1, 1.2, 2.1, 2.2, 3.1, 3.2, 3.3_

  - [x] 1.2 编写计算示例单元测试
    - 测试示例 1：365 元/365 天，剩余 100 天，升级到 680 元/年，预期升级价格 86.30 元
    - 测试示例 2：兑换码会员（实付 0 元），剩余 100 天，升级到 680 元/年，预期升级价格 186.30 元
    - _Requirements: 4.1, 4.2_

  - [x] 1.3 编写当前剩余价值计算属性测试
    - **Property 1: 当前剩余价值计算正确性**
    - **Validates: Requirements 1.1, 1.2**

  - [x] 1.4 编写目标剩余价值计算属性测试
    - **Property 2: 目标剩余价值计算正确性**
    - **Validates: Requirements 2.1, 2.2**

  - [x] 1.5 编写升级价格计算属性测试
    - **Property 3: 升级价格计算正确性**
    - **Validates: Requirements 3.1, 3.2, 3.3**

- [x] 2. 检查点 - 验证计算逻辑
  - ✅ 运行单元测试验证计算示例（8 个测试全部通过）
  - ✅ 运行属性测试验证计算公式
  - 无问题

- [x] 3. 边界条件处理
  - [x] 3.1 验证边界条件处理
    - ✅ 确保剩余天数不超过总天数（使用 Math.min）
    - ✅ 确保剩余天数不为负数（使用 Math.max(0, ...)）
    - ✅ 确保实付金额为 0 时正确处理（兑换码会员测试通过）
    - ✅ 确保只有月价时正确计算年价（边界条件测试通过）
    - _Requirements: 1.3, 1.4, 2.3_

  - [x] 3.2 编写剩余天数约束属性测试
    - ✅ **Property 4: 剩余天数约束**（测试通过）
    - **Validates: Requirements 1.4**

- [x] 4. 最终检查点
  - ✅ 所有 8 个测试通过
  - ✅ 计算结果符合预期
  - 无问题

## 注意事项

- 修改计算逻辑后，需要确保不影响现有的升级流程
- 所有金额计算都需要四舍五入到分（保留两位小数）
- 升级价格不能为负数
- 测试时需要覆盖各种边界情况
