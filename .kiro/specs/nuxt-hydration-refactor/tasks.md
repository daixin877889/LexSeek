# 实现计划：Nuxt 水合状态修复

## 概述

重构 `app/app.vue` 中的初始化逻辑，将异步操作移到 `onMounted` 钩子中，解决 SSR 水合状态不匹配问题。

## 任务

- [x] 1. 重构 app.vue 初始化逻辑
  - [x] 1.1 将异步数据获取移到 onMounted 钩子
    - 创建 `initializeUserData` 函数封装异步操作
    - 在 `onMounted` 中调用该函数
    - 使用 `Promise.all` 并行获取用户信息和角色信息
    - 添加 try-catch 错误处理
    - _需求: 2.1, 2.2, 3.1, 3.2, 4.2, 4.3_

  - [x] 1.2 修改 watch 配置
    - 移除 `immediate: true` 选项
    - 在 `initializeUserData` 中手动触发首次路由获取
    - _需求: 3.3, 4.1_

  - [x] 1.3 添加错误处理
    - 确保 `fetchUserInfo` 失败不影响应用运行
    - 确保 `getUserRoles` 失败不影响应用运行
    - 记录错误日志
    - _需求: 5.1, 5.2, 5.3_

- [x] 2. 验证修复效果
  - [x] 2.1 检查点 - 验证水合状态
    - 确保开发环境控制台无水合警告
    - 确保用户数据正确加载
    - 确保角色切换功能正常
    - 如有问题请告知用户

## 备注

- 本次修改是代码结构重构，不涉及业务逻辑变更
- 核心验证方式是检查控制台是否有水合警告
- `initAuth()` 保持在 setup 顶层，因为它是同步读取 cookie
