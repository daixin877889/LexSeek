# Design Document

## Overview

本设计解决项目中时间存储到 PostgreSQL 数据库时的时区问题。核心问题是 Node.js 的 `new Date()` 返回 UTC 时间，但数据库（时区为 Asia/Shanghai）会将其误解为已经是 +08 时区的时间，导致存储的时间比实际时间早 8 小时。

解决方案是使用 day.js 及其时区插件来正确处理 Asia/Shanghai 时区，创建一个时区工具模块，并更新所有数据库写入代码使用这些工具函数。

## Architecture

```
┌─────────────────────────────────────────────────────────┐
│                    Application Layer                     │
├─────────────────────────────────────────────────────────┤
│  API Handlers (server/api/v1/*)                         │
│       │                                                  │
│       ▼                                                  │
│  ┌─────────────────────────────────────────────────┐    │
│  │  Timezone Utility (server/utils/timezone.ts)    │    │
│  │  - dayjs (with timezone plugin)                 │    │
│  │  - now(): Date (Asia/Shanghai)                  │    │
│  │  - addMinutes(date, minutes): Date              │    │
│  │  - addHours(date, hours): Date                  │    │
│  └─────────────────────────────────────────────────┘    │
│       │                                                  │
│       ▼                                                  │
│  Prisma Client (server/utils/db.ts)                     │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│  PostgreSQL Database (timezone: Asia/Shanghai)          │
│  - Timestamptz columns                                  │
└─────────────────────────────────────────────────────────┘
```

## Components and Interfaces

### 1. Dependencies

需要安装 day.js 及其时区插件：

```bash
bun add dayjs
```

### 2. Timezone Utility Module

**文件位置**: `server/utils/timezone.ts`

```typescript
import dayjs from 'dayjs'
import utc from 'dayjs/plugin/utc'
import timezone from 'dayjs/plugin/timezone'

// 配置 dayjs 插件
dayjs.extend(utc)
dayjs.extend(timezone)

// 时区常量
export const TIMEZONE = 'Asia/Shanghai'

/**
 * 获取当前 Asia/Shanghai 时区的时间
 * 用于数据库存储
 */
export function now(): Date

/**
 * 在指定时间基础上增加分钟数
 * @param date 基准时间（可选，默认为当前时间）
 * @param minutes 要增加的分钟数
 */
export function addMinutes(minutes: number, date?: Date): Date

/**
 * 在指定时间基础上增加小时数
 * @param date 基准时间（可选，默认为当前时间）
 * @param hours 要增加的小时数
 */
export function addHours(hours: number, date?: Date): Date

/**
 * 将任意 Date 对象转换为 Asia/Shanghai 时区
 * @param date 要转换的时间
 */
export function toTimezone(date: Date): Date
```

### 3. 实现原理

使用 day.js 的时区插件来正确处理时区转换：

```typescript
import dayjs from 'dayjs'
import utc from 'dayjs/plugin/utc'
import timezone from 'dayjs/plugin/timezone'

dayjs.extend(utc)
dayjs.extend(timezone)

// 获取当前 Asia/Shanghai 时间
export function now(): Date {
    return dayjs().tz('Asia/Shanghai').toDate()
}

// 示例：当前 UTC 时间是 2025-12-19 00:00:00
// dayjs().tz('Asia/Shanghai') 返回 2025-12-19 08:00:00 (Asia/Shanghai)
// .toDate() 转换为正确的 Date 对象
```

day.js 的优势：
- 内置时区支持，无需手动计算偏移量
- 自动处理夏令时（虽然中国没有夏令时）
- API 简洁易用
- 体积小巧（约 2KB gzipped）

## Data Models

无需修改数据模型，现有的 Prisma schema 中的 `@db.Timestamptz()` 类型是正确的。

需要修改的是数据写入时的时间生成方式。

## Correctness Properties

*A property is a characteristic or behavior that should hold true across all valid executions of a system-essentially, a formal statement about what the system should do. Properties serve as the bridge between human-readable specifications and machine-verifiable correctness guarantees.*

### Property 1: Timezone offset consistency

*For any* timestamp generated by the `now()` function, the resulting Date object's time value should represent the current Asia/Shanghai local time when interpreted as UTC.

**Validates: Requirements 1.1, 2.1**

### Property 2: Time addition correctness

*For any* base timestamp and positive offset value (minutes or hours), the resulting timestamp should be exactly that offset ahead of the base timestamp, preserving timezone consistency.

**Validates: Requirements 2.2**

### Property 3: Round-trip time consistency

*For any* timestamp generated by the utility functions, storing it to the database and reading it back should yield a time that represents the same moment in Asia/Shanghai timezone.

**Validates: Requirements 1.2, 1.3, 2.3**

## Error Handling

1. **无效输入处理**: `addMinutes` 和 `addHours` 函数应验证输入参数
   - 如果 `date` 不是有效的 Date 对象，抛出 TypeError
   - 如果 `minutes/hours` 不是有效数字，抛出 TypeError

2. **边界情况**: 
   - 负数偏移量应该正常工作（用于计算过去的时间）
   - 极大的偏移量应该正常工作

## Testing Strategy

### 单元测试

使用 Vitest 进行单元测试：

1. 测试 `now()` 函数返回的时间与系统时间的关系
2. 测试 `addMinutes()` 和 `addHours()` 的计算正确性
3. 测试 `toTimezone()` 的转换正确性
4. 测试边界情况（负数、零、大数值）

### 属性测试

使用 fast-check 进行属性测试：

1. **Property 1 测试**: 生成随机时间点，验证 `now()` 的输出与预期偏移量一致
2. **Property 2 测试**: 生成随机基准时间和偏移量，验证时间加法的正确性
3. **Property 3 测试**: 需要数据库集成，可作为集成测试

每个属性测试配置运行 100 次迭代。

测试文件标注格式：`**Feature: timezone-fix, Property {number}: {property_text}**`
