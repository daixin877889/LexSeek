# Docker Compose 配置文件
# 使用方式: docker compose up -d

services:
  # LexSeek 应用服务
  lexseek:
    build:
      context: .
      dockerfile: Dockerfile
    image: lexseek:latest
    container_name: lexseek-app
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      # 基础配置
      - NODE_ENV=production
      - NUXT_HOST=0.0.0.0
      - NUXT_PORT=3000
      # 数据库连接（必填）
      - DATABASE_URL=${DATABASE_URL}
      # JWT 配置
      - NUXT_JWT_SECRET=${NUXT_JWT_SECRET:-lexseek_jwt_secret}
      - NUXT_JWT_EXPIRES_IN=${NUXT_JWT_EXPIRES_IN:-30d}
      # 认证配置
      - NUXT_AUTH_COOKIE_NAME=${NUXT_AUTH_COOKIE_NAME:-auth_token}
      - NUXT_AUTH_COOKIE_MAX_AGE=${NUXT_AUTH_COOKIE_MAX_AGE:-2592000}
      # 阿里云配置
      - NUXT_ALIYUN_ACCESS_KEY_ID=${NUXT_ALIYUN_ACCESS_KEY_ID}
      - NUXT_ALIYUN_ACCESS_KEY_SECRET=${NUXT_ALIYUN_ACCESS_KEY_SECRET}
      # 阿里云短信配置
      - NUXT_ALIYUN_SMS_ENABLE=${NUXT_ALIYUN_SMS_ENABLE:-false}
      - NUXT_ALIYUN_SMS_SIGN_NAME=${NUXT_ALIYUN_SMS_SIGN_NAME}
      - NUXT_ALIYUN_SMS_TEMPLATE_CAPTCHA_CODE=${NUXT_ALIYUN_SMS_TEMPLATE_CAPTCHA_CODE}
      # 存储配置
      - NUXT_STORAGE_DEFAULT_TYPE=${NUXT_STORAGE_DEFAULT_TYPE:-aliyun_oss}
      - NUXT_STORAGE_CALLBACK_URL=${NUXT_STORAGE_CALLBACK_URL}
      - NUXT_STORAGE_BASE_PATH=${NUXT_STORAGE_BASE_PATH}
      # 阿里云 OSS 配置
      - NUXT_STORAGE_ALIYUN_OSS_ACCESS_KEY_ID=${NUXT_STORAGE_ALIYUN_OSS_ACCESS_KEY_ID}
      - NUXT_STORAGE_ALIYUN_OSS_ACCESS_KEY_SECRET=${NUXT_STORAGE_ALIYUN_OSS_ACCESS_KEY_SECRET}
      - NUXT_STORAGE_ALIYUN_OSS_BUCKET=${NUXT_STORAGE_ALIYUN_OSS_BUCKET}
      - NUXT_STORAGE_ALIYUN_OSS_REGION=${NUXT_STORAGE_ALIYUN_OSS_REGION}
      - NUXT_STORAGE_ALIYUN_OSS_CUSTOM_DOMAIN=${NUXT_STORAGE_ALIYUN_OSS_CUSTOM_DOMAIN}
      # 日志级别
      - NUXT_PUBLIC_LOG_LEVEL=${NUXT_PUBLIC_LOG_LEVEL:-INFO}
    healthcheck:
      test: ["CMD", "bun", "-e", "fetch('http://localhost:3000/api/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - lexseek-network
    # 可选：挂载日志目录（如果需要持久化日志）
    # volumes:
    #   - ./logs:/app/logs

networks:
  lexseek-network:
    driver: bridge
