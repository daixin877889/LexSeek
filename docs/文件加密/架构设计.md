# 架构设计

本文档介绍文件加密模块的架构设计和数据流。

## 模块架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                           前端应用                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐ │
│  │   页面组件       │    │   对话框组件     │    │   上传组件       │ │
│  │                 │    │                 │    │                 │ │
│  │ file-encryption │    │ SetupDialog     │    │ fileUploader    │ │
│  │ disk-space      │    │ PasswordDialog  │    │                 │ │
│  │                 │    │ ChangePassword  │    │                 │ │
│  │                 │    │ RecoveryKey     │    │                 │ │
│  └────────┬────────┘    └────────┬────────┘    └────────┬────────┘ │
│           │                      │                      │          │
│           └──────────────────────┼──────────────────────┘          │
│                                  │                                  │
│                                  ▼                                  │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │                     useEncryptionStore                         │ │
│  │                                                                │ │
│  │  - config (加密配置)                                           │ │
│  │  - hasEncryption (是否已配置)                                  │ │
│  │  - isUnlocked (私钥是否解锁)                                   │ │
│  │  - fetchConfig() / saveConfig() / updateConfig()              │ │
│  └───────────────────────────────┬───────────────────────────────┘ │
│                                  │                                  │
│                                  ▼                                  │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │                       useAgeCrypto                             │ │
│  │                                                                │ │
│  │  - identity (私钥)                                             │ │
│  │  - generateKeyPair() / encryptIdentity() / decryptIdentity()  │ │
│  │  - unlockIdentity() / lockIdentity() / restoreIdentity()      │ │
│  │  - encryptFile() / decryptFile() / decryptToObjectURL()       │ │
│  └───────────────────────────────┬───────────────────────────────┘ │
│                                  │                                  │
│           ┌──────────────────────┼──────────────────────┐          │
│           │                      │                      │          │
│           ▼                      ▼                      ▼          │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐ │
│  │   Web Worker    │    │   IndexedDB     │    │  age-encryption │ │
│  │                 │    │                 │    │                 │ │
│  │ crypto.worker   │    │ 私钥本地存储     │    │ 加密库          │ │
│  │ 加密/解密执行    │    │ (AES-GCM 加密)  │    │                 │ │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘ │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                           后端服务                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                    API 接口                                  │   │
│  │                                                              │   │
│  │  GET  /api/v1/encryption/config     获取加密配置             │   │
│  │  POST /api/v1/encryption/config     保存加密配置             │   │
│  │  PUT  /api/v1/encryption/config     更新加密配置             │   │
│  │  POST /api/v1/encryption/recovery   恢复密钥重置             │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                  │                                  │
│                                  ▼                                  │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                    数据库存储                                │   │
│  │                                                              │   │
│  │  User 表:                                                    │   │
│  │  - encryptionPublicKey (公钥)                                │   │
│  │  - encryptedPrivateKey (加密后的私钥)                        │   │
│  │  - encryptedRecoveryKey (恢复密钥加密的私钥)                 │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

## 数据流

### 首次设置加密

```
用户输入密码
      │
      ▼
┌─────────────────┐
│ generateKeyPair │ ──→ 生成 identity + recipient
└─────────────────┘
      │
      ▼
┌─────────────────┐
│ encryptIdentity │ ──→ 用密码加密 identity
└─────────────────┘
      │
      ▼
┌─────────────────┐
│   saveConfig    │ ──→ 保存到服务器
└─────────────────┘
      │
      ▼
┌─────────────────┐
│ unlockIdentity  │ ──→ 解锁并保存到 IndexedDB
└─────────────────┘
```

### 文件加密上传

```
用户选择文件
      │
      ▼
┌─────────────────┐
│  validateFile   │ ──→ 验证文件类型和大小
└─────────────────┘
      │
      ▼
┌─────────────────┐
│   encryptFile   │ ──→ Web Worker 中加密
└─────────────────┘     (使用 recipient 公钥)
      │
      ▼
┌─────────────────┐
│ getPresignedUrl │ ──→ 获取 OSS 上传签名
└─────────────────┘     (encrypted: true)
      │
      ▼
┌─────────────────┐
│   uploadToOSS   │ ──→ 上传加密后的文件
└─────────────────┘     (文件名: xxx.jpg.age)
```

### 文件解密预览

```
请求文件 URL
      │
      ▼
┌─────────────────┐
│ isEncryptedUrl  │ ──→ 判断是否为 .age 文件
└─────────────────┘
      │
      ├─── 否 ──→ 直接返回原 URL
      │
      ▼ 是
┌─────────────────┐
│ restoreIdentity │ ──→ 从 IndexedDB 恢复私钥
└─────────────────┘
      │
      ├─── 未解锁 ──→ 抛出 IdentityNotUnlockedError
      │
      ▼ 已解锁
┌─────────────────┐
│  fetch(url)     │ ──→ 下载加密文件
└─────────────────┘
      │
      ▼
┌─────────────────┐
│   decryptFile   │ ──→ Web Worker 中解密
└─────────────────┘     (使用 identity 私钥)
      │
      ▼
┌─────────────────┐
│ createObjectURL │ ──→ 创建 Blob URL
└─────────────────┘
```

### 私钥解锁流程

```
用户输入密码
      │
      ▼
┌─────────────────┐
│ decryptIdentity │ ──→ 用密码解密 encryptedIdentity
└─────────────────┘
      │
      ├─── 失败 ──→ 抛出 WrongPasswordError
      │
      ▼ 成功
┌─────────────────┐
│ globalIdentity  │ ──→ 保存到内存
└─────────────────┘
      │
      ▼
┌─────────────────┐
│ saveIdentityToDB│ ──→ 加密后保存到 IndexedDB
└─────────────────┘     (使用设备指纹派生的密钥)
```

## 组件职责

### useAgeCrypto

核心加密 composable，负责：
- 密钥对生成
- 私钥加密/解密
- 文件加密/解密
- 私钥状态管理（内存 + IndexedDB）

**全局状态**：
```typescript
// 跨组件共享的全局状态
const globalIdentity = ref<string | null>(null)
const currentUserId = ref<number | null>(null)
const isRestored = ref(false)
```

### useEncryptionStore

加密配置状态管理，负责：
- 从服务器获取/保存加密配置
- 提供加密状态的响应式数据
- 协调 useAgeCrypto 的解锁状态

### crypto.worker.ts

Web Worker，负责：
- 在独立线程中执行加密/解密
- 避免阻塞主线程
- 使用 Transferable 传输大文件

**消息协议**：
```typescript
// 请求
{ type: 'encrypt', id: string, data: ArrayBuffer, recipient: string }
{ type: 'decrypt', id: string, data: ArrayBuffer, identity: string }

// 响应
{ type: 'success', id: string, data: ArrayBuffer }
{ type: 'error', id: string, error: string, errorType?: string }
{ type: 'progress', id: string, progress: number }
```

### fileUploader.vue

文件上传组件，负责：
- 文件选择和验证
- 加密开关控制
- 调用 encryptFile 加密
- 上传到 OSS

## 存储设计

### 服务器存储

```
User 表
├── encryptionPublicKey     VARCHAR   公钥 (age1...)
├── encryptedPrivateKey     TEXT      加密后的私钥 (Base64)
└── encryptedRecoveryKey    TEXT      恢复密钥加密的私钥 (Base64, 可选)
```

### 客户端存储 (IndexedDB)

```
数据库: encryption-store
└── 对象存储: identity
    └── 键: identity-user-{userId}
        └── 值: AES-GCM 加密后的私钥 (Base64)
```

**存储格式**：
```
IV (12 bytes) + 密文 → Base64 编码
```

### OSS 存储

```
文件路径规则:
├── 普通文件: /files/{userId}/{date}/{uuid}.{ext}
└── 加密文件: /files/{userId}/{date}/{uuid}.{ext}.age
```

## 安全边界

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户设备                                  │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                    安全区域                                │ │
│  │                                                           │ │
│  │  • 原始私钥 (内存中)                                       │ │
│  │  • 解密后的文件内容                                        │ │
│  │  • 用户密码 (仅在输入时)                                   │ │
│  │                                                           │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                    本地存储                                │ │
│  │                                                           │ │
│  │  • IndexedDB: 设备指纹加密的私钥                          │ │
│  │    (换设备需重新解锁)                                      │ │
│  │                                                           │ │
│  └───────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ HTTPS
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        服务器                                    │
│                                                                 │
│  • 公钥 (可公开)                                                │
│  • 密码加密的私钥 (无法解密)                                    │
│  • 恢复密钥加密的私钥 (无法解密)                                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        OSS 存储                                  │
│                                                                 │
│  • 加密后的文件 (无法解密)                                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 错误处理

### 错误类型层级

```
Error
├── IdentityNotUnlockedError  (私钥未解锁)
├── IdentityMismatchError     (私钥不匹配)
├── InvalidAgeFileError       (文件格式无效)
├── FileCorruptedError        (文件损坏)
└── WrongPasswordError        (密码错误)
```

### 错误传播

```
Worker 错误
    │
    ▼
Worker postMessage({ type: 'error', errorType: '...' })
    │
    ▼
useAgeCrypto 转换为具体错误类
    │
    ▼
组件 catch 并显示用户友好的错误信息
```

## 性能优化

### Web Worker

- 加密/解密在独立线程执行，不阻塞 UI
- 使用 Transferable 传输 ArrayBuffer，避免复制

### 懒加载

- age-encryption 库按需动态导入
- Worker 实例懒加载，首次使用时创建

### 内存管理

- Object URL 使用后及时释放
- 大文件使用流式处理（Worker 中）
