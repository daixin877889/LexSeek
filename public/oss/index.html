<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>文件上传 - OSS</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            border: "hsl(214.3 31.8% 91.4%)",
            input: "hsl(214.3 31.8% 91.4%)",
            ring: "hsl(222.2 84% 4.9%)",
            background: "hsl(0 0% 100%)",
            foreground: "hsl(222.2 84% 4.9%)",
            primary: {
              DEFAULT: "hsl(222.2 47.4% 11.2%)",
              foreground: "hsl(210 40% 98%)",
            },
            secondary: {
              DEFAULT: "hsl(210 40% 96.1%)",
              foreground: "hsl(222.2 47.4% 11.2%)",
            },
            muted: {
              DEFAULT: "hsl(210 40% 96.1%)",
              foreground: "hsl(215.4 16.3% 46.9%)",
            },
            accent: {
              DEFAULT: "hsl(210 40% 96.1%)",
              foreground: "hsl(222.2 47.4% 11.2%)",
            },
            destructive: {
              DEFAULT: "hsl(0 84.2% 60.2%)",
              foreground: "hsl(210 40% 98%)",
            },
          },
          borderRadius: {
            lg: "0.5rem",
            md: "calc(0.5rem - 2px)",
            sm: "calc(0.5rem - 4px)",
          },
        },
      },
    };
  </script>
  <style>
    /* 自定义拖拽区域样式 */
    .drop-zone {
      transition: all 0.2s ease;
    }

    .drop-zone.dragover {
      border-color: hsl(222.2 47.4% 11.2%);
      background-color: hsl(210 40% 96.1%);
    }

    /* 进度条动画 */
    .progress-bar {
      transition: width 0.3s ease;
    }

    /* 文件图标 */
    .file-icon {
      width: 40px;
      height: 40px;
    }
  </style>
</head>

<body class="min-h-screen bg-gray-50/50">
  <div class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md">
      <!-- 卡片容器 -->
      <div class="bg-white rounded-lg border shadow-sm">
        <!-- 卡片头部 -->
        <div class="flex flex-col space-y-1.5 p-6 pb-4">
          <h3 class="text-2xl font-semibold leading-none tracking-tight">文件上传</h3>
          <p class="text-sm text-muted-foreground">选择或拖拽文件到下方区域进行上传</p>
        </div>

        <!-- 卡片内容 -->
        <div class="p-6 pt-0">
          <form id="upload-form">
            <!-- 场景选择 -->
            <div class="mb-4">
              <label for="source-select" class="block text-sm font-medium text-gray-700 mb-1">上传场景</label>
              <select id="source-select"
                class="w-full h-10 px-3 rounded-md border border-input bg-background text-sm focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2">
                <option value="">加载中...</option>
              </select>
              <p id="accept-hint" class="mt-1 text-xs text-gray-500"></p>
            </div>

            <!-- 拖拽上传区域 -->
            <div id="drop-zone"
              class="drop-zone relative border-2 border-dashed border-gray-200 rounded-lg p-8 text-center cursor-pointer hover:border-gray-300 hover:bg-gray-50/50">
              <input type="file" id="file" name="file" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                required />
              <div id="upload-placeholder" class="space-y-2">
                <!-- 上传图标 -->
                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                  <path
                    d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <div class="text-sm text-gray-600">
                  <span class="font-medium text-primary">点击上传</span>
                  <span class="text-gray-500"> 或拖拽文件到此处</span>
                </div>
                <p id="file-types-hint" class="text-xs text-gray-500">请先选择上传场景</p>
              </div>

              <!-- 已选文件显示 -->
              <div id="file-preview" class="hidden">
                <div class="flex items-center justify-center space-x-3">
                  <svg class="file-icon text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                      d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                  <div class="text-left">
                    <p id="file-name" class="text-sm font-medium text-gray-900 truncate max-w-[200px]"></p>
                    <p id="file-size" class="text-xs text-gray-500"></p>
                  </div>
                  <button type="button" id="remove-file" class="p-1 hover:bg-gray-100 rounded">
                    <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                </div>
              </div>
            </div>

            <!-- 上传进度 -->
            <div id="progress-container" class="hidden mt-4">
              <div class="flex justify-between text-sm mb-1">
                <span class="text-gray-600">上传中...</span>
                <span id="progress-text" class="text-gray-600">0%</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div id="progress-bar" class="progress-bar bg-primary h-2 rounded-full" style="width: 0%"></div>
              </div>
            </div>

            <!-- 上传按钮 -->
            <button type="submit" id="submit-btn"
              class="mt-4 w-full inline-flex items-center justify-center rounded-md text-sm font-medium h-10 px-4 py-2 bg-primary text-primary-foreground hover:bg-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
              <svg id="btn-icon" class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
              </svg>
              <span id="btn-text">上传文件</span>
            </button>
          </form>
        </div>
      </div>

      <!-- 回调信息卡片 -->
      <div id="callback-info" class="hidden mt-4 bg-white rounded-lg border shadow-sm">
        <div class="flex flex-col space-y-1.5 p-6 pb-4">
          <div class="flex items-center space-x-2">
            <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <h3 class="text-lg font-semibold leading-none tracking-tight">上传成功</h3>
          </div>
          <p class="text-sm text-muted-foreground">文件已成功上传到 OSS</p>
        </div>
        <div class="p-6 pt-0">
          <pre id="callback-content"
            class="text-xs bg-gray-50 rounded-md p-4 overflow-auto max-h-48 text-gray-700"></pre>
        </div>
      </div>

      <!-- 错误提示 -->
      <div id="error-info" class="hidden mt-4 bg-destructive/10 border border-destructive/20 rounded-lg p-4">
        <div class="flex items-center space-x-2">
          <svg class="w-5 h-5 text-destructive" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <p id="error-text" class="text-sm text-destructive font-medium"></p>
        </div>
      </div>
    </div>
  </div>

  <script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function () {
      const form = document.querySelector("#upload-form");
      const fileInput = document.querySelector("#file");
      const dropZone = document.querySelector("#drop-zone");
      const uploadPlaceholder = document.querySelector("#upload-placeholder");
      const filePreview = document.querySelector("#file-preview");
      const fileName = document.querySelector("#file-name");
      const fileSize = document.querySelector("#file-size");
      const removeFileBtn = document.querySelector("#remove-file");
      const progressContainer = document.querySelector("#progress-container");
      const progressBar = document.querySelector("#progress-bar");
      const progressText = document.querySelector("#progress-text");
      const submitBtn = document.querySelector("#submit-btn");
      const btnText = document.querySelector("#btn-text");
      const btnIcon = document.querySelector("#btn-icon");
      const callbackInfo = document.querySelector("#callback-info");
      const callbackContent = document.querySelector("#callback-content");
      const errorInfo = document.querySelector("#error-info");
      const errorText = document.querySelector("#error-text");
      const sourceSelect = document.querySelector("#source-select");
      const acceptHint = document.querySelector("#accept-hint");
      const fileTypesHint = document.querySelector("#file-types-hint");

      // 场景配置数据
      let sourceConfigs = [];
      // 场景名称到 source 值的映射
      const sourceNameToValue = {
        "云盘上传": "file",
        "语音识别": "asr",
        "文档识别": "doc",
        "图片识别": "image",
        "视频": "video",
        "案件分析": "caseAnalysis"
      };

      // 格式化文件大小
      function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      // 加载场景配置
      async function loadSourceConfigs() {
        try {
          const response = await fetch("/api/v1/files/presigned-url/config");
          if (!response.ok) throw new Error("获取配置失败");
          const result = await response.json();
          sourceConfigs = result.data || [];

          // 填充下拉选项
          sourceSelect.innerHTML = '<option value="">请选择上传场景</option>';
          sourceConfigs.forEach((config, index) => {
            if (config.accept && config.accept.length > 0) {
              const option = document.createElement("option");
              option.value = sourceNameToValue[config.name] || config.name;
              option.textContent = config.name;
              option.dataset.index = index;
              sourceSelect.appendChild(option);
            }
          });
        } catch (error) {
          console.error("加载配置失败:", error);
          sourceSelect.innerHTML = '<option value="">加载失败，请刷新</option>';
        }
      }

      // 更新文件类型提示
      function updateAcceptHint() {
        const selectedOption = sourceSelect.options[sourceSelect.selectedIndex];
        if (!selectedOption || !selectedOption.dataset.index) {
          acceptHint.textContent = "";
          fileTypesHint.textContent = "请先选择上传场景";
          fileInput.accept = "";
          return;
        }

        const config = sourceConfigs[selectedOption.dataset.index];
        if (config && config.accept) {
          const extensions = config.accept.map(a => "." + a.name).join(", ");
          const mimeTypes = config.accept.map(a => a.mime).filter(Boolean);
          const maxSizes = config.accept.map(a => formatFileSize(a.maxSize));

          acceptHint.textContent = `支持格式: ${extensions}`;
          fileTypesHint.textContent = `支持 ${extensions}`;
          fileInput.accept = mimeTypes.join(",");
        }
      }

      // 验证文件
      function validateFile(file) {
        const selectedOption = sourceSelect.options[sourceSelect.selectedIndex];
        if (!selectedOption || !selectedOption.dataset.index) {
          return { valid: false, message: "请先选择上传场景" };
        }

        const config = sourceConfigs[selectedOption.dataset.index];
        if (!config || !config.accept) {
          return { valid: false, message: "配置错误" };
        }

        // 检查文件类型
        const acceptItem = config.accept.find(a => a.mime === file.type);
        if (!acceptItem) {
          const extensions = config.accept.map(a => "." + a.name).join(", ");
          return { valid: false, message: `不支持的文件类型，请上传 ${extensions} 格式` };
        }

        // 检查文件大小
        if (file.size > acceptItem.maxSize) {
          return { valid: false, message: `文件大小超出限制，最大 ${formatFileSize(acceptItem.maxSize)}` };
        }

        return { valid: true };
      }

      // 显示已选文件
      function showFilePreview(file) {
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        uploadPlaceholder.classList.add("hidden");
        filePreview.classList.remove("hidden");
      }

      // 重置文件选择
      function resetFileInput() {
        fileInput.value = "";
        uploadPlaceholder.classList.remove("hidden");
        filePreview.classList.add("hidden");
      }

      // 显示错误
      function showError(message) {
        errorText.textContent = message;
        errorInfo.classList.remove("hidden");
        setTimeout(() => {
          errorInfo.classList.add("hidden");
        }, 5000);
      }

      // 设置按钮状态
      function setButtonLoading(loading) {
        submitBtn.disabled = loading;
        if (loading) {
          btnIcon.innerHTML = '<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>';
          btnIcon.classList.add("animate-spin");
          btnText.textContent = "上传中...";
        } else {
          btnIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />';
          btnIcon.classList.remove("animate-spin");
          btnText.textContent = "上传文件";
        }
      }

      // 场景选择变化
      sourceSelect.addEventListener("change", function () {
        updateAcceptHint();
        // 如果已选择文件，重新验证
        if (fileInput.files && fileInput.files[0]) {
          const validation = validateFile(fileInput.files[0]);
          if (!validation.valid) {
            showError(validation.message);
            resetFileInput();
          }
        }
      });

      // 文件选择事件
      fileInput.addEventListener("change", function () {
        if (this.files && this.files[0]) {
          const validation = validateFile(this.files[0]);
          if (!validation.valid) {
            showError(validation.message);
            resetFileInput();
            return;
          }
          showFilePreview(this.files[0]);
          errorInfo.classList.add("hidden");
          callbackInfo.classList.add("hidden");
        }
      });

      // 移除文件按钮
      removeFileBtn.addEventListener("click", function (e) {
        e.stopPropagation();
        resetFileInput();
      });

      // 拖拽事件
      dropZone.addEventListener("dragover", function (e) {
        e.preventDefault();
        this.classList.add("dragover");
      });

      dropZone.addEventListener("dragleave", function (e) {
        e.preventDefault();
        this.classList.remove("dragover");
      });

      dropZone.addEventListener("drop", function (e) {
        e.preventDefault();
        this.classList.remove("dragover");
        if (e.dataTransfer.files && e.dataTransfer.files[0]) {
          const file = e.dataTransfer.files[0];
          const validation = validateFile(file);
          if (!validation.valid) {
            showError(validation.message);
            return;
          }
          fileInput.files = e.dataTransfer.files;
          showFilePreview(file);
          errorInfo.classList.add("hidden");
          callbackInfo.classList.add("hidden");
        }
      });

      // 表单提交
      form.addEventListener("submit", (event) => {
        event.preventDefault();

        const source = sourceSelect.value;
        if (!source) {
          showError("请先选择上传场景");
          return;
        }

        const file = fileInput.files[0];
        if (!file) {
          showError("请选择一个文件再上传");
          return;
        }

        const validation = validateFile(file);
        if (!validation.valid) {
          showError(validation.message);
          return;
        }

        setButtonLoading(true);
        progressContainer.classList.remove("hidden");
        callbackInfo.classList.add("hidden");
        errorInfo.classList.add("hidden");

        // 构建请求参数
        const params = new URLSearchParams({
          source: source,
          fileSize: file.size.toString(),
          mimeType: file.type,
          originalFileName: file.name
        });

        fetch(`/api/v1/files/presigned-url?${params}`, { method: "GET" })
          .then((response) => {
            if (!response.ok) {
              return response.json().then(err => {
                throw new Error(err.message || "获取签名失败");
              });
            }
            return response.json();
          })
          .then((resData) => {
            const data = resData.data;
            console.log('服务端返回的签名数据:', data);
            console.log('callbackVar:', data.callbackVar);

            let formData = new FormData();
            formData.append("success_action_status", "200");
            formData.append("policy", data.policy);
            formData.append("x-oss-signature", data.signature);
            formData.append("x-oss-signature-version", data.signatureVersion);
            formData.append("x-oss-credential", data.credential);
            formData.append("x-oss-date", data.date);
            // 使用服务端生成的 key，如果没有则回退到 dir + 原始文件名
            formData.append("key", data.key || (data.dir + file.name));
            // 仅在使用 STS 时添加 security token
            if (data.securityToken) {
              formData.append("x-oss-security-token", data.securityToken);
            }
            // 仅在配置了回调时添加 callback
            if (data.callback) {
              formData.append("callback", data.callback);
            }
            // 添加回调自定义变量
            // 根据阿里云 OSS 官方文档，PostObject 表单上传时，自定义变量直接作为表单字段传递
            // 例如：formData.append("x:userId", "1")
            if (data.callbackVar) {
              console.log('添加 callbackVar 到 FormData:');
              for (const [key, value] of Object.entries(data.callbackVar)) {
                console.log(`  ${key} = ${value}`);
                formData.append(key, String(value));
              }
            }
            formData.append("file", file);

            // 使用 XMLHttpRequest 以支持进度显示
            return new Promise((resolve, reject) => {
              const xhr = new XMLHttpRequest();

              xhr.upload.addEventListener("progress", (e) => {
                if (e.lengthComputable) {
                  const percent = Math.round((e.loaded / e.total) * 100);
                  progressBar.style.width = percent + "%";
                  progressText.textContent = percent + "%";
                }
              });

              xhr.addEventListener("load", () => {
                if (xhr.status === 200) {
                  try {
                    resolve(JSON.parse(xhr.responseText));
                  } catch {
                    resolve(null);
                  }
                } else {
                  reject(new Error("上传失败"));
                }
              });

              xhr.addEventListener("error", () => reject(new Error("网络错误")));

              xhr.open("POST", data.host);
              xhr.send(formData);
            });
          })
          .then((callbackData) => {
            setButtonLoading(false);
            progressContainer.classList.add("hidden");
            progressBar.style.width = "0%";

            if (callbackData) {
              callbackContent.textContent = JSON.stringify(callbackData, null, 2);
              callbackInfo.classList.remove("hidden");
            } else {
              callbackInfo.classList.remove("hidden");
              callbackContent.textContent = "文件上传成功";
            }

            resetFileInput();
          })
          .catch((error) => {
            console.error("发生错误:", error);
            setButtonLoading(false);
            progressContainer.classList.add("hidden");
            progressBar.style.width = "0%";
            showError(error.message || "上传失败，请稍后再试");
          });
      });

      // 初始化加载配置
      loadSourceConfigs();
    });
  </script>
</body>

</html>